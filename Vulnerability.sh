#!/bin/bash

# Colors
G='\033[0;32m'
R='\033[0;31m'
Y='\033[1;33m'
C='\033[0;36m'
NC='\033[0m'

function banner() {
    clear
    echo -e "${C}====================================================="
    echo -e "       PROFESSIONAL VAPT SCANNER (ALL-IN-ONE)        "
    echo -e "=====================================================${NC}"
}

# --- Tool Checker & Installer ---
function check_tools() {
    echo -e "${Y}[*] Checking required tools...${NC}"
    tools=("curl" "nmap" "sqlmap" "dirb")
    for tool in "${tools[@]}"; do
        if ! command -v $tool &> /dev/null; then
            echo -e "${R}[!] $tool is not installed. Installing...${NC}"
            sudo apt-get install $tool -y || pkg install $tool -y
        else
            echo -e "${G}[+] $tool is ready.${NC}"
        fi
    done
}

# --- 1. Injection Flaws (SQLi & Command Injection) ---
function injection_test() {
    echo -e "\n${C}>>> 1. TESTING INJECTION FLAWS${NC}"
    # Automated SQLi using sqlmap (Basic Scan)
    echo -e "${Y}[*] Running sqlmap on $target...${NC}"
    sqlmap -u "$target" --batch --crawl=2 --level=1 --risk=1
    
    # Command Injection Manual Check
    echo -e "${Y}[*] Testing Command Injection...${NC}"
    res=$(curl -s -L "$target?cmd=whoami")
    if [[ $res =~ "root" || $res =~ "www-data" ]]; then
        echo -e "${R}[!!!] VULNERABLE: Command Injection Possible!${NC}"
    fi
}

# --- 2. Broken Access Control (IDOR & Privilege) ---
function access_control_test() {
    echo -e "\n${C}>>> 2. TESTING ACCESS CONTROL (IDOR)${NC}"
    # Testing parameter swapping
    params=("user_id" "id" "account" "user")
    for p in "${params[@]}"; do
        echo -e "${Y}[*] Testing parameter: $p=11 (Swapping from 10)${NC}"
        res=$(curl -s -o /dev/null -w "%{http_code}" "$target?$p=11")
        if [ $res -eq 200 ]; then
            echo -e "${G}[+] Potential IDOR found on parameter: $p${NC}"
        fi
    done
}

# --- 3. XSS (Cross-Site Scripting) ---
function xss_test() {
    echo -e "\n${C}>>> 3. TESTING XSS${NC}"
    payloads=("<script>alert(1)</script>" "'><img src=x onerror=alert(1)>" "javascript:alert(1)")
    for p in "${payloads[@]}"; do
        res=$(curl -s -L "$target?q=$p")
        if [[ "$res" == *"$p"* ]]; then
            echo -e "${R}[!!!] VULNERABLE: XSS found with payload: $p${NC}"
        fi
    done
}

# --- 4. Broken Authentication ---
function auth_test() {
    echo -e "\n${C}>>> 4. TESTING AUTHENTICATION${NC}"
    # Directory Brute Forcing for Auth Panels
    dirb "$target" /usr/share/dirb/wordlists/common.txt -z 100
}

# --- 5. Security Misconfiguration ---
function misconfig_test() {
    echo -e "\n${C}>>> 5. TESTING MISCONFIGURATIONS${NC}"
    # Port Scan and Banner Grabbing
    echo -e "${Y}[*] Scanning Ports and Server Info...${NC}"
    nmap -sV --script http-enum "$target"
    
    # Check for .env or config files
    files=(".env" "config.php.bak" "phpinfo.php" "robots.txt")
    for f in "${files[@]}"; do
        status=$(curl -s -o /dev/null -w "%{http_code}" "$target/$f")
        if [ $status -eq 200 ]; then
            echo -e "${R}[!!!] Sensitive File Found: $target/$f${NC}"
        fi
    done
}

# --- Main Logic ---
banner
check_tools
echo -e "\n${C}Enter Target URL:${NC}"
read target

while true; do
    echo -e "\n${Y}--- MAIN MENU ---${NC}"
    echo "1. Injection Test (SQLi/CMD)"
    echo "2. Access Control (IDOR)"
    echo "3. XSS Test"
    echo "4. Auth & Admin Panel Scan"
    echo "5. Misconfig & Info Leakage"
    echo "6. FULL SECURITY AUDIT"
    echo "0. Exit"
    echo -n "Select > "
    read opt

    case $opt in
        1) injection_test ;;
        2) access_control_test ;;
        3) xss_test ;;
        4) auth_test ;;
        5) misconfig_test ;;
        6) injection_test; access_control_test; xss_test; auth_test; misconfig_test ;;
        0) exit ;;
        *) echo "Invalid choice" ;;
    esac
done
